{% extends "base.html" %}

{% block title %}Edit Instrument - Calibration Manager{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-0">
                <i class="bi bi-pencil me-2"></i>Edit Instrument
            </h1>
            <p class="text-muted">Update instrument details and calibration schedule</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('instruments') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Instruments
            </a>
        </div>
    </div>

    <!-- Edit Instrument Form -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear me-2"></i>Instrument Details
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="editInstrumentForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="row g-3">
        <!-- Basic Information -->
        <div class="col-12">
            <h6 class="text-muted border-bottom pb-2 mb-3">Basic Information</h6>
        </div>
        
        <div class="col-md-6">
            <label for="name" class="form-label">
                Instrument Name <span class="text-danger">*</span>
            </label>
            <input type="text" 
                   class="form-control" 
                   id="name" 
                   name="name" 
                   value="{{ instrument.name }}"
                   required
                   placeholder="e.g., Digital Scale, pH Meter">
            <div class="form-text">Descriptive name for the instrument</div>
        </div>
        
        <div class="col-md-6">
            <label for="serial_number" class="form-label">Serial Number</label>
            <input type="text" 
                   class="form-control" 
                   id="serial_number" 
                   name="serial_number"
                   value="{{ instrument.serial_number or '' }}"
                   placeholder="e.g., ABC123456">
            <div class="form-text">Manufacturer's serial number</div>
        </div>
        
        <div class="col-md-6">
            <label for="manufacturer" class="form-label">Manufacturer</label>
            <input type="text" 
                   class="form-control" 
                   id="manufacturer" 
                   name="manufacturer"
                   value="{{ instrument.manufacturer or '' }}"
                   placeholder="e.g., Mettler Toledo, Thermo Fisher">
            <div class="form-text">Instrument manufacturer</div>
        </div>
        
        <div class="col-md-6">
            <label for="model" class="form-label">Model</label>
            <input type="text" 
                   class="form-control" 
                   id="model" 
                   name="model"
                   value="{{ instrument.model or '' }}"
                   placeholder="e.g., XS205, Orion Star A111">
            <div class="form-text">Model number or name</div>
        </div>
        
        <div class="col-12">
            <label for="location" class="form-label">Location</label>
            <input type="text" 
                   class="form-control" 
                   id="location" 
                   name="location"
                   value="{{ instrument.location or '' }}"
                   placeholder="e.g., Lab 1, Room 205, Building A">
            <div class="form-text">Where the instrument is located</div>
        </div>

        <!-- Calibration Information -->
        <div class="col-12 mt-4">
            <h6 class="text-muted border-bottom pb-2 mb-3">Calibration Schedule</h6>
        </div>
        
        <div class="col-md-6">
            <label for="last_calibration_date" class="form-label">
                Last Calibration Date <span class="text-danger">*</span>
            </label>
            <input type="date" 
                   class="form-control" 
                   id="last_calibration_date" 
                   name="last_calibration_date" 
                   value="{{ instrument.last_calibration_date }}"
                   required>
            <div class="form-text">When was this instrument last calibrated?</div>
        </div>
        
        <div class="col-md-6">
            <label for="calibration_frequency" class="form-label">
                Calibration Frequency <span class="text-danger">*</span>
            </label>
            <div class="input-group">
                <input type="number" 
                       class="form-control" 
                       id="calibration_frequency" 
                       name="calibration_frequency" 
                       value="{{ instrument.calibration_frequency }}"
                       min="1" 
                       max="3650" 
                       required
                       placeholder="365">
                <span class="input-group-text">days</span>
            </div>
            <div class="form-text">How often should this instrument be calibrated?</div>
        </div>

        <!-- Quick Frequency Buttons -->
        <div class="col-12">
            <label class="form-label">Common Frequencies</label>
            <div class="d-flex gap-2 flex-wrap">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setFrequency(30)">Monthly (30 days)</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setFrequency(90)">Quarterly (90 days)</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setFrequency(180)">Semi-Annual (180 days)</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setFrequency(365)">Annual (365 days)</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setFrequency(730)">Biennial (730 days)</button>
            </div>
        </div>

        <!-- Current Status Display -->
        <div class="col-12">
            <div class="alert alert-info">
                <h6 class="alert-heading mb-2">
                    <i class="bi bi-info-circle me-2"></i>Current Status
                </h6>
                <div id="statusDisplay">
                    <p class="mb-1">Calculating current calibration status...</p>
                </div>
            </div>
        </div>

        <!-- Additional Notes -->
        <div class="col-12 mt-4">
            <h6 class="text-muted border-bottom pb-2 mb-3">Additional Information</h6>
        </div>
        
        <div class="col-12">
            <label for="notes" class="form-label">Notes</label>
            <textarea class="form-control" 
                      id="notes" 
                      name="notes" 
                      rows="3"
                      placeholder="Additional notes about the instrument, calibration requirements, special handling, etc.">{{ instrument.notes or '' }}</textarea>
            <div class="form-text">Optional notes about the instrument or calibration requirements</div>
        </div>

        <!-- Audit Information -->
        {% if instrument.created_at or instrument.updated_at %}
        <div class="col-12 mt-4">
            <h6 class="text-muted border-bottom pb-2 mb-3">Record Information</h6>
            <div class="row text-muted small">
                {% if instrument.created_at %}
                <div class="col-md-6">
                    <i class="bi bi-calendar-plus me-1"></i>
                    Created: {{ instrument.created_at }}
                </div>
                {% endif %}
                {% if instrument.updated_at %}
                <div class="col-md-6">
                    <i class="bi bi-calendar-check me-1"></i>
                    Last Updated: {{ instrument.updated_at }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Form Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex gap-2 justify-content-between border-top pt-3">
                <!-- Left side - destructive action -->
                <button type="button" 
                        class="btn btn-outline-danger" 
                        onclick="confirmDelete({{ instrument.id }}, {{ instrument.name|tojson }})">
                    <i class="bi bi-trash me-2"></i>Delete Instrument
                </button>
                
                <!-- Right side - primary actions -->
                <div class="d-flex gap-2">
                    <a href="{{ url_for('instruments') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="deleteForm" method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Warning!</strong> This action cannot be undone.
                    </div>
                    <p>Are you sure you want to delete the instrument <strong id="deleteInstrumentName"></strong>?</p>
                    <p class="text-muted small">This will also delete all associated calibration reminders.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>Delete Instrument
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Function to set frequency from quick buttons
function setFrequency(days) {
    document.getElementById('calibration_frequency').value = days;
    updateStatus();
}

// Function to calculate and display current status
function updateStatus() {
    const lastCalDate = document.getElementById('last_calibration_date').value;
    const frequency = parseInt(document.getElementById('calibration_frequency').value);
    
    if (lastCalDate && frequency) {
        const lastDate = new Date(lastCalDate);
        const nextDate = new Date(lastDate.getTime() + (frequency * 24 * 60 * 60 * 1000));
        const today = new Date();
        const diffTime = nextDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        let statusHtml = '';
        if (diffDays < 0) {
            statusHtml = `
                <span class="badge bg-danger me-2">Overdue</span>
                <span class="text-danger">This instrument is ${Math.abs(diffDays)} days overdue for calibration</span>
            `;
        } else if (diffDays <= 30) {
            statusHtml = `
                <span class="badge bg-warning text-dark me-2">Due Soon</span>
                <span class="text-warning">Calibration due in ${diffDays} days (${nextDate.toDateString()})</span>
            `;
        } else {
            statusHtml = `
                <span class="badge bg-success me-2">Current</span>
                <span class="text-success">Next calibration due in ${diffDays} days (${nextDate.toDateString()})</span>
            `;
        }
        
        document.getElementById('statusDisplay').innerHTML = statusHtml;
    } else {
        document.getElementById('statusDisplay').innerHTML = '<p class="mb-1 text-muted">Enter calibration date and frequency to see status</p>';
    }
}

// Confirm delete function
function confirmDelete(instrumentId, instrumentName) {
    document.getElementById('deleteInstrumentName').textContent = instrumentName;
    document.getElementById('deleteForm').action = `/instruments/${instrumentId}/delete`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Initialize status display
document.addEventListener('DOMContentLoaded', function() {
    updateStatus();

    const lastCalInput = document.getElementById('last_calibration_date');
    const freqInput = document.getElementById('calibration_frequency');
    const nameInput = document.getElementById('name');
    const form = document.getElementById('editInstrumentForm');

    if (lastCalInput) lastCalInput.addEventListener('change', updateStatus);
    if (freqInput) freqInput.addEventListener('input', updateStatus);

    if (form) {
        form.addEventListener('submit', function(e) {
            const name = nameInput.value.trim();
            const lastCalDate = lastCalInput.value;
            const frequency = parseInt(freqInput.value);

            if (!name) {
                e.preventDefault();
                alert('Please enter an instrument name.');
                nameInput.focus();
                return;
            }

            if (!lastCalDate) {
                e.preventDefault();
                alert('Please select the last calibration date.');
                lastCalInput.focus();
                return;
            }

            if (!frequency || frequency < 1) {
                e.preventDefault();
                alert('Please enter a valid calibration frequency (at least 1 day).');
                freqInput.focus();
                return;
            }

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            submitBtn.disabled = true;
        });
    }

    if (nameInput) {
        nameInput.addEventListener('input', function() {
            this.classList.toggle('is-invalid', this.value.trim().length === 0);
            this.classList.toggle('is-valid', this.value.trim().length > 0);
        });
    }

    if (freqInput) {
        freqInput.addEventListener('input', function() {
            const value = parseInt(this.value);
            this.classList.toggle('is-invalid', !value || value < 1);
            this.classList.toggle('is-valid', value && value >= 1);
        });
    }

    if (lastCalInput) {
        lastCalInput.addEventListener('change', function() {
            this.classList.toggle('is-invalid', !this.value);
            this.classList.toggle('is-valid', !!this.value);
        });
    }
});
</script>
{% endblock %}
